# Cloudflare D1 数据库操作指南

## 🎯 直接操作D1数据库步骤

### 方法1：使用Cloudflare控制台（推荐）

1. **登录Cloudflare控制台**
   - 访问：https://dash.cloudflare.com
   - 登录您的账户

2. **找到D1数据库**
   - 在左侧菜单选择"Workers & Pages"
   - 点击"D1"
   - 找到数据库：`oursql`

3. **执行SQL命令**
   - 点击数据库名称进入详情页
   - 选择"Console"选项卡
   - 粘贴下面的SQL命令并执行：

```sql
-- 步骤1：添加排序字段
ALTER TABLE photos ADD COLUMN sort_order INTEGER DEFAULT 0;

-- 步骤2：创建索引（可选，但推荐）
CREATE INDEX idx_photos_sort_order ON photos(album_id, sort_order);

-- 步骤3：更新现有数据
UPDATE photos SET sort_order = id;

-- 步骤4：验证结果
SELECT COUNT(*) as total_photos FROM photos;
SELECT COUNT(*) as photos_with_sort FROM photos WHERE sort_order IS NOT NULL;
```

### 方法2：使用Wrangler CLI（命令行）

如果您已安装Wrangler CLI，可以直接在终端执行：

```bash
# 执行SQL文件
wrangler d1 execute baoandkai-d1 --file=./d1_migration.sql

# 或者直接执行SQL命令
wrangler d1 execute baoandkai-d1 --command="ALTER TABLE photos ADD COLUMN sort_order INTEGER DEFAULT 0;"
```

## 🔍 验证修改结果

执行以下查询验证修改是否成功：

```sql
-- 查看表结构
.schema photos

-- 检查数据
SELECT 
    album_id,
    url,
    sort_order,
    created_at
FROM photos 
ORDER BY album_id, sort_order
LIMIT 20;

-- 统计每个相册的照片数量
SELECT 
    album_id,
    COUNT(*) as photo_count,
    MIN(sort_order) as first_order,
    MAX(sort_order) as last_order
FROM photos 
GROUP BY album_id
ORDER BY album_id;
```

## ⚠️ 注意事项

1. **备份建议**：虽然D1会自动备份，但建议在修改前导出数据
2. **执行顺序**：必须按顺序执行，先添加字段，再更新数据
3. **兼容性**：新添加的字段不会影响现有代码运行

## 🚀 下一步

数据库修改完成后，您需要：

1. 重新部署网站（GitHub Actions会自动部署）
2. 进入管理员后台编辑相册，拖拽调整照片顺序
3. 保存后，相册会按您设置的顺序展示

整个过程大约需要5-10分钟完成。